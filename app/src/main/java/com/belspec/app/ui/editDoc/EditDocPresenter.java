package com.belspec.app.ui.editDoc;

import android.content.Context;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.net.Uri;
import android.os.Bundle;
import android.provider.MediaStore;
import android.util.Log;

import com.belspec.app.adapters.ImageListAdapter;
import com.belspec.app.gps.GPSTracker;
import com.belspec.app.retrofit.Api;
import com.belspec.app.retrofit.RetrofitService;
import com.belspec.app.retrofit.model.DetectionDoc;
import com.belspec.app.retrofit.model.Image;
import com.belspec.app.retrofit.model.ImageList;
import com.belspec.app.retrofit.model.addPhoto.request.AddPhotoRequestEnvelope;
import com.belspec.app.retrofit.model.addPhoto.response.AddPhotoResponseEnvelope;
import com.belspec.app.retrofit.model.getItemImage.request.GetItemImageRequestEnvelope;
import com.belspec.app.retrofit.model.getItemImage.response.GetItemImageResponseEnvelope;
import com.belspec.app.utils.Converter;
import com.belspec.app.utils.Encode;
import com.belspec.app.utils.FileManager;
import com.belspec.app.utils.UserManager;

import java.io.File;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;

import retrofit2.Call;
import retrofit2.Callback;
import retrofit2.Response;


class EditDocPresenter implements EditDocContract.Presenter {
    private EditDocContract.View view;
    private Context context;
    private DetectionDoc detectionDoc;
    private ImageListAdapter imageListAdapter;
    private int curItem;
    private ArrayList<String> stringArrayParkingList;

    EditDocPresenter(EditDocContract.View view) {
        this.view = view;
        this.context = view.getViewContext();
        curItem = 1;
    }


    @Override
    public void onCreate(Bundle savedInstanceState, Intent intent) {
        detectionDoc = intent.getParcelableExtra(DetectionDoc.class.getCanonicalName());
        view.setManufacture(detectionDoc.getManufacture());
        view.setModel(detectionDoc.getModel());
        view.setDocId(detectionDoc.getId());
        view.setCarId(detectionDoc.getCarId());
        SimpleDateFormat df = new SimpleDateFormat("dd-MM-yyyy");
        view.setDateDetection(df.format(detectionDoc.getDateDetection()));
        view.setContractor(detectionDoc.getContractor());
        view.setStatus(detectionDoc.getStatus());
        view.setParking(detectionDoc.getParking());
        view.setAvatar(Converter.getBitmapFromBase64Stirng(context, detectionDoc.getImage()));
        if (savedInstanceState == null) {
            Log.d("DEBUG", "initComponents(null) EditDocActivity");
            view.setLoading(true);
            imageListAdapter = new ImageListAdapter();
            view.setAdapter(imageListAdapter);
            curItem = 1;
            getImageFromApi(detectionDoc.getId(), curItem);
        } else {
            Log.d("DEBUG", "initCompontnts(bundl) EditDocActivity");
            view.setLoading(false);
            imageListAdapter = savedInstanceState.getParcelable("imageListAdapter");
            view.setAdapter(imageListAdapter);
            stringArrayParkingList = savedInstanceState.getStringArrayList("parkingList");
            view.setParking(savedInstanceState.getString("itemParking"));
        }
    }

    @Override
    public void onSavedInstanceState(Bundle bundle) {
        Log.d("DEBUG", "onSaveInstanceState() EditDocActivity");
        bundle.putStringArrayList("parkingList", stringArrayParkingList);
        bundle.putString("itemParking", view.getParking());
        bundle.putParcelable("imageListAdapter", imageListAdapter);
    }

    @Override
    public void onAddImageClick() {
        Log.d("DEBUG", "onClick(btnEvacuationAddImage) EditDocActivity");
        Intent intent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);
        File photoFile = null;
        try {
            photoFile = FileManager.createImageFile(context);
        } catch (IOException ex) {
            ex.printStackTrace();
        }
        if (photoFile != null) {
            imageListAdapter.addFilePath(photoFile.getAbsolutePath());
            Uri photoURI = Uri.fromFile(photoFile);
            intent.putExtra(MediaStore.EXTRA_OUTPUT, photoURI);
            view.startPhotoActivity(intent);
        }
    }

    @Override
    public void onAddImage() {
        GPSTracker gps = GPSTracker.getInstance();
        Converter.compressImage(imageListAdapter.getCurrentPath(), Bitmap.CompressFormat.JPEG, 80, 1024);
        if (gps.setGpsToFile(imageListAdapter.getCurrentPath())) {
            BitmapFactory.Options opt = new BitmapFactory.Options();
            opt.inSampleSize = 8;
            Bitmap bitmap = BitmapFactory.decodeFile(imageListAdapter.getCurrentPath(), opt);
            imageListAdapter.add(bitmap);
        } else {
            imageListAdapter.deleteCurrentPath();
        }
    }

    @Override
    public void onAddImageCancel() {
        imageListAdapter.deleteCurrentPath();
    }

    @Override
    public void onSaveClick() {
        Log.d("DEBUG", "onClick(btnSave) EditDocActivity");
        view.setLoading(true);
        saveDoc();
    }

    @Override
    public void onDestroy() {
        Log.d("DEBUG", "onDestroy EditDocActivity");
        imageListAdapter.clear();
    }

    private void saveDoc() {
        Log.d("DEBUG", "SaveDoc EditDocActivity");
        RetrofitService retrofitService = Api.createRetrofitService();
        ImageList imageList = new ImageList();
        int count = imageListAdapter.getFilePathCount();
        if (count > 0) {
            for (int i = 0; i < count; i++) {
                imageList.addImage(new Image().setData(Converter.encodeToBase64(imageListAdapter.getFilePath(i))));
            }
        } else {
            imageList.addImage(new Image().setData(""));
        }
        retrofitService.executeAddPhoto(
                Encode.getBasicAuthTemplate(
                        UserManager.getInstanse().getmLogin(),
                        UserManager.getInstanse().getmPassword()
                ),
                new AddPhotoRequestEnvelope(
                        detectionDoc.getId(),
                        imageList)
        ).enqueue(new Callback<AddPhotoResponseEnvelope>() {
            @Override
            public void onResponse(Call<AddPhotoResponseEnvelope> call, Response<AddPhotoResponseEnvelope> response) {
                view.setLoading(false);
                if(response.isSuccessful()){
                    Log.d("DEBUG", "AuthorizationOK(addPhoto) EditDocActivity");
                    AddPhotoResponseEnvelope responseEnvelope = response.body();
                    if (responseEnvelope != null) {
                        if (responseEnvelope.getBool()) {
                            view.showMessage("Успешно сохранено");
                        } else {
                            view.showMessage("Ошибка при сохранении на сервере");
                        }
                    } else {
                        view.showMessage("Ответ сервера не содержит результата");
                    }
                }else{
                    Log.d("ERROR", response.message());
                }
            }

            @Override
            public void onFailure(Call<AddPhotoResponseEnvelope> call, Throwable t) {
                Log.d("ERROR", t.getMessage());
                view.setLoading(false);
            }
        });
    }

    private void getImageFromApi(String docId, int index) {
        RetrofitService retrofitService = Api.createRetrofitService();
        retrofitService.executeGetItemImage(
                Encode.getBasicAuthTemplate(
                        UserManager.getInstanse().getmLogin(),
                        UserManager.getInstanse().getmPassword()
                ),
                new GetItemImageRequestEnvelope(docId, index)
        ).enqueue(new Callback<GetItemImageResponseEnvelope>() {
            @Override
            public void onResponse(Call<GetItemImageResponseEnvelope> call, Response<GetItemImageResponseEnvelope> response) {
                view.setLoading(false);
                if(response.isSuccessful()){
                    Log.d("DEBUG", "AutorizationOK(getItemImage) EditDocActivity");
                    GetItemImageResponseEnvelope responseEnvelope = response.body();
                    if (responseEnvelope != null) {
                        view.setAdapter(imageListAdapter);
                        imageListAdapter.add(Converter.getBitmapFromBase64Stirng(context, responseEnvelope.getImage()));
                        curItem++;
                        getImageFromApi(detectionDoc.getId(), curItem);
                    }
                }else{
                    Log.d("ERROR", response.message());
                }
            }

            @Override
            public void onFailure(Call<GetItemImageResponseEnvelope> call, Throwable t) {
                Log.d("ERROR", t.getMessage());
                view.setLoading(false);
            }
        });
    }
}
