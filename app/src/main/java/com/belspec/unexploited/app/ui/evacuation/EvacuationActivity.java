package com.belspec.unexploited.app.ui.evacuation;

import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.graphics.drawable.AnimationDrawable;
import android.os.Bundle;
import android.support.annotation.Nullable;
import android.support.v7.app.AppCompatActivity;
import android.support.v7.widget.LinearLayoutManager;
import android.support.v7.widget.RecyclerView;
import android.support.v7.widget.Toolbar;
import android.view.MenuItem;
import android.view.View;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.ImageView;
import android.widget.RadioButton;
import android.widget.ScrollView;
import android.widget.Spinner;
import android.widget.TextView;

import com.belspec.unexploited.app.R;
import com.belspec.unexploited.app.retrofit.model.DetectionDoc;
import com.belspec.unexploited.app.ui.ImageActivity;
import com.belspec.unexploited.app.utils.Converter;
import com.belspec.unexploited.app.utils.Utils;

import java.text.SimpleDateFormat;
import java.util.List;

import butterknife.BindView;
import butterknife.ButterKnife;


public class EvacuationActivity extends AppCompatActivity implements View.OnClickListener, EvacuationContract.View {
    @BindView(R.id.btnEvacuationAddImage)
    Button btnAddImage;
    @BindView(R.id.btnCreateEvacuation)
    Button btnCreateEvacuation;
    @BindView(R.id.txvStatus)
    TextView txvStatus;
    @BindView(R.id.txvItemManuf)
    TextView txvEvacuationManufacture;
    @BindView(R.id.txvItemModel)
    TextView txvEvacuationModel;
    @BindView(R.id.txvDocId)
    TextView txvEvacuationDocId;
    @BindView(R.id.txvItemCarID)
    TextView txvEvacuationCarId;
    @BindView(R.id.txvDateDetection)
    TextView txvEvacuationDateDetection;
    @BindView(R.id.txvItemContractor)
    TextView txvEvacuationContractor;
    @BindView(R.id.txvNoticeIn)
    TextView txvNoticeIn;
    @BindView(R.id.txvNoticeOut)
    TextView txvNoticeOut;
    @BindView(R.id.txvEvacuationDate)
    TextView txvEvacuationDate;
    @BindView(R.id.txvReleaseDate)
    TextView txvReleaseDate;
    @BindView(R.id.txvUtilizationDate)
    TextView txvUtilizationDate;
    @BindView(R.id.txvParking)
    TextView txvParking;
    @BindView(R.id.txvItemPoliceDep)
    TextView txvPoliceDepartment;
    @BindView(R.id.imvFoto)
    ImageView imvAvatar;
    @BindView(R.id.rbNoCarId)
    RadioButton rbNoCarId;
    @BindView(R.id.rbNoAction)
    RadioButton rbNoAction;
    @BindView(R.id.rbNoOwner)
    RadioButton rbNoOwner;
    @BindView(R.id.rvEvacuationImageList)
    RecyclerView rvImageFromBase;
    @BindView(R.id.spnParking)
    Spinner spnParking;
    @BindView(R.id.svAll)
    ScrollView svAll;
    @BindView(R.id.imvLoading)
    ImageView imvLoading;
    @BindView(R.id.toolbar)
    Toolbar toolbar;
    public static final String EVACUATION_RESULT_KEY = "evacuation_result";
    EvacuationContract.Presenter presenter;
    LinearLayoutManager llm;
    final int REQUEST_CODE_PHOTO = 1;
    @BindView(R.id.rvAddedImageList)
    RecyclerView addedRecycler;

    @Override
    protected void onCreate(@Nullable Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.evacuation_activity);
        ButterKnife.bind(this);
        initViews();
        initComponents();
        presenter = new EvacuationPresenter(this);
        presenter.onCreate(savedInstanceState, getIntent());
    }

    private void initViews() {
        setSupportActionBar(toolbar);
        if (getSupportActionBar() != null)
            getSupportActionBar().setDisplayHomeAsUpEnabled(true);
    }

    private void initComponents() {
        btnAddImage.setOnClickListener(this);
        btnCreateEvacuation.setOnClickListener(this);
        llm = new LinearLayoutManager(this);
        llm.setOrientation(LinearLayoutManager.HORIZONTAL);
        rvImageFromBase.setLayoutManager(llm);
        addedRecycler.setLayoutManager(new LinearLayoutManager(this, LinearLayoutManager.HORIZONTAL, false));

    }

    @Override
    public boolean onOptionsItemSelected(MenuItem item) {
        if (item.getItemId() == android.R.id.home) {
            finish();
        }
        return super.onOptionsItemSelected(item);
    }

    @Override
    protected void onSaveInstanceState(Bundle outState) {
        presenter.onSaveInstanceState(outState);
        super.onSaveInstanceState(outState);
    }

    @Override
    public void onClick(View view) {
        switch (view.getId()) {
            case R.id.btnEvacuationAddImage:
                presenter.onAddPhotoClick();
                break;
            case R.id.btnCreateEvacuation:
                presenter.onCreateEvacuationClick();
                break;
        }
    }

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        if (requestCode == REQUEST_CODE_PHOTO) {
            if (resultCode == Activity.RESULT_OK) {
                presenter.onAddPhoto();
            } else if (resultCode == Activity.RESULT_CANCELED) {
                presenter.onAddPhotoCancel();
            }
        }
    }

    @Override
    public void setLoading(boolean bool) {
        AnimationDrawable animation = (AnimationDrawable) imvLoading.getBackground();
        if (bool) {
            svAll.setVisibility(View.GONE);
            imvLoading.setVisibility(View.VISIBLE);
            animation.start();
        } else {
            svAll.setVisibility(View.VISIBLE);
            imvLoading.setVisibility(View.GONE);
            animation.stop();
        }
    }

    @Override
    public void showDocumentDetails(DetectionDoc doc) {
        setTextTo(txvStatus, "Статус", doc.getStatus());
        setTextTo(txvEvacuationDocId, "Документ №", doc.getId());
        setTextTo(txvEvacuationManufacture, "Марка", doc.getManufacture());
        setTextTo(txvEvacuationModel, "Модель", doc.getModel());
        setTextTo(txvEvacuationCarId, "Регистрационный номер", doc.getCarId());
        setTextTo(txvPoliceDepartment, "ГАИ", doc.getPolDep());
        setTextTo(txvEvacuationContractor, "Район", doc.getContractor());
        setTextTo(txvParking, "Стоянка", doc.getParking());
        imvAvatar.setImageBitmap(Converter.getBitmapFromBase64Stirng(this, doc.getImage()));

        SimpleDateFormat df = new SimpleDateFormat("dd-MM-yyyy");
        try {
            setTextTo(txvEvacuationDateDetection, "Дата обнаружения", df.format(doc.getDateDetection()));
        } catch (Exception e) {
            setTextTo(txvEvacuationDateDetection, "", "");
        }
        try {
            setTextTo(txvReleaseDate, "Дата выдачи", df.format(doc.getReleaseDate()));
        } catch (Exception e) {
            setTextTo(txvReleaseDate, "", "");
        }
        try {
            setTextTo(txvEvacuationDate, "Дата эвакуации", df.format(doc.getEvacuationDate()));
        } catch (Exception e) {
            setTextTo(txvEvacuationDate, "", "");
        }
        try {
            setTextTo(txvUtilizationDate, "Дата утилизации", df.format(doc.getUtilizationDate()));
        } catch (Exception e) {
            setTextTo(txvUtilizationDate, "", "");
        }
        try {
            setTextTo(txvNoticeIn, "Дата получения извещения владельцем", df.format(doc.getNoticeIn()));
        } catch (Exception e) {
            setTextTo(txvNoticeIn, "", "");
        }
        try {
            setTextTo(txvNoticeOut, "Дата отправления извещения владельцу", df.format(doc.getNoticeOut()));
        } catch (Exception e) {
            setTextTo(txvNoticeOut, "", "");
        }
    }

    private void setTextTo(TextView textView, String prefix, String argument) {
        textView.setVisibility(argument != null && !argument.isEmpty() ? View.VISIBLE : View.GONE);
        textView.setText(String.format("%s : %s", prefix, argument));
    }

    @Override
    public Context getViewContext() {
        return getApplication();
    }

    @Override
    public void setNetworkAdapter(RecyclerView.Adapter adapter) {
        rvImageFromBase.setAdapter(adapter);
    }

    @Override
    public void setAddedAdapter(RecyclerView.Adapter adapter) {
        addedRecycler.setAdapter(adapter);
    }

    @Override
    public void setNoAction(boolean bool) {
        rbNoAction.setChecked(bool);
    }

    @Override
    public void setParkings(List<String> parkings) {
        spnParking.setAdapter(new ArrayAdapter<>(this, R.layout.spinner_item, parkings));
    }

    @Override
    public void setParkingItemSelection(int position) {
        spnParking.setSelection(position);
    }

    @Override
    public int getParkingSelectedPosition() {
        return spnParking.getSelectedItemPosition();
    }

    @Override
    public String getParkingSelectedItem() {
        return spnParking.getSelectedItem().toString();
    }

    @Override
    public void getPhoto(Intent intent) {
        startActivityForResult(intent, REQUEST_CODE_PHOTO);
    }

    @Override
    public boolean getNoAction() {
        return rbNoAction.isChecked();
    }

    @Override
    public boolean getNoOwner() {
        return rbNoOwner.isChecked();
    }

    @Override
    public boolean getNoCarId() {
        return rbNoCarId.isChecked();
    }

    @Override
    public void showMessage(String message) {
        Utils.showMessage(this, message);
    }

    @Override
    public void showImage(String id) {
        startActivity(ImageActivity.getIntent(this, id));
    }

    @Override
    public void close(String result) {
        Intent intent = new Intent();
        intent.putExtra(EVACUATION_RESULT_KEY, result);
        setResult(Activity.RESULT_OK, intent);
        finish();
    }
}
