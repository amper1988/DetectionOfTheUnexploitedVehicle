package com.belspec.detectionoftheunexploitedvehicle;

import android.app.Activity;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.net.Uri;
import android.os.Bundle;
import android.provider.MediaStore;
import android.support.annotation.Nullable;
import android.support.v7.app.AppCompatActivity;
import android.support.v7.widget.LinearLayoutManager;
import android.support.v7.widget.RecyclerView;
import android.util.Log;
import android.view.View;
import android.widget.ArrayAdapter;
import android.widget.Button;
import android.widget.EditText;
import android.widget.ImageView;
import android.widget.Spinner;
import android.widget.Switch;
import android.widget.TextView;
import android.widget.Toast;

import com.belspec.detectionoftheunexploitedvehicle.Adapters.ImageListAdapter;
import com.belspec.detectionoftheunexploitedvehicle.Gps.GPSTracker;
import com.belspec.detectionoftheunexploitedvehicle.Interface.ResponseListener;
import com.belspec.detectionoftheunexploitedvehicle.Retrofit.Api;
import com.belspec.detectionoftheunexploitedvehicle.Retrofit.Model.Contractor;
import com.belspec.detectionoftheunexploitedvehicle.Retrofit.Model.CreateEvacuation.Request.CreateEvacuationRequestEnvelope;
import com.belspec.detectionoftheunexploitedvehicle.Retrofit.Model.CreateEvacuation.Response.CreateEvacuationResponseEnvelope;
import com.belspec.detectionoftheunexploitedvehicle.Retrofit.Model.DetectionDoc;
import com.belspec.detectionoftheunexploitedvehicle.Retrofit.Model.GetItemImage.Request.GetItemImageRequestEnvelope;
import com.belspec.detectionoftheunexploitedvehicle.Retrofit.Model.GetItemImage.Response.GetItemImageResponseEnvelope;
import com.belspec.detectionoftheunexploitedvehicle.Retrofit.Model.GetParkingList.Request.GetParkingListRequestEnvelope;
import com.belspec.detectionoftheunexploitedvehicle.Retrofit.Model.GetParkingList.Response.GetParkingListResponseEnvelope;
import com.belspec.detectionoftheunexploitedvehicle.Retrofit.Model.Image;
import com.belspec.detectionoftheunexploitedvehicle.Retrofit.Model.ImageList;
import com.belspec.detectionoftheunexploitedvehicle.Retrofit.Model.Parking;
import com.belspec.detectionoftheunexploitedvehicle.Retrofit.Model.TakeDefaultData.Request.GetDefaultDataRequestEnvelope;
import com.belspec.detectionoftheunexploitedvehicle.Retrofit.Model.TakeDefaultData.Response.GetDefaultDataResponseEnvelope;
import com.belspec.detectionoftheunexploitedvehicle.Retrofit.RetrofitService;
import com.belspec.detectionoftheunexploitedvehicle.Utils.Converter;
import com.belspec.detectionoftheunexploitedvehicle.Utils.Encode;
import com.belspec.detectionoftheunexploitedvehicle.Utils.FileManager;

import java.io.File;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.List;

import retrofit2.Response;

/**
 * Created by GWAdmin on 30.08.2016.
 */
public class EvacuationActivity extends AppCompatActivity implements View.OnClickListener, ResponseListener{
    Button btnAddImage;
    Button btnCreateEvacuation;
    TextView txvEvacuationManufacture;
    TextView txvEvacuationModel;
    TextView txvEvacuationDocId;
    TextView txvEvacuationCarId;
    TextView txvEvacuationDateDetection;
    TextView txvEvacuationContractor;
    ImageView imvAvatar;
    Switch swEvacuationOrder;
    RecyclerView rvImageFromBase;
    LinearLayoutManager llm;
    DetectionDoc detectionDoc;
    Spinner spnParking;
    int curItem;
    final int REQUEST_CODE_PHOTO = 1;

    @Override
    protected void onCreate(@Nullable Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.evacuation_activity);
        initViews();
        initComponents();
    }

    private void initViews(){
        btnAddImage = (Button)findViewById(R.id.btnEvacuationAddImage);
        btnCreateEvacuation = (Button)findViewById(R.id.btnCreateEvacuation);
        txvEvacuationManufacture = (TextView)findViewById(R.id.txvEvacuationManufacture);
        txvEvacuationModel = (TextView)findViewById(R.id.txvEvacuationModel);
        txvEvacuationDocId = (TextView)findViewById(R.id.txvEvacuationDocID);
        txvEvacuationCarId = (TextView)findViewById(R.id.txvEvacuationCarID);
        txvEvacuationDateDetection = (TextView)findViewById(R.id.txvEvacuationDateDetection);
        txvEvacuationContractor = (TextView)findViewById(R.id.txvEvacuationContractor);
        swEvacuationOrder = (Switch)findViewById(R.id.swEvacuationOrder);
        imvAvatar = (ImageView)findViewById(R.id.imvAvatar);
        rvImageFromBase = (RecyclerView)findViewById(R.id.rvEvacuationImageList);
        spnParking = (Spinner)findViewById(R.id.spnParking);
    }

    private void initComponents(){
        btnAddImage.setOnClickListener(this);
        btnCreateEvacuation.setOnClickListener(this);
        detectionDoc = getIntent().getParcelableExtra(DetectionDoc.class.getCanonicalName());
        txvEvacuationManufacture.setText(detectionDoc.getManufacture());
        txvEvacuationModel.setText(detectionDoc.getModel());
        txvEvacuationDocId.setText(detectionDoc.getId());
        txvEvacuationCarId.setText(detectionDoc.getCarId());
        SimpleDateFormat df = new SimpleDateFormat("dd-MM-yyyy");
        txvEvacuationDateDetection.setText(df.format(detectionDoc.getDateDetection()));
        txvEvacuationContractor.setText(detectionDoc.getContractor());
        imvAvatar.setImageBitmap(Converter.getBitmapFromBase64Stirng(this, detectionDoc.getImage()));
        llm = new LinearLayoutManager(this);
        llm.setOrientation(LinearLayoutManager.HORIZONTAL);
        ImageListAdapter.getInstance().clear();
        rvImageFromBase.setAdapter(ImageListAdapter.getInstance());
        rvImageFromBase.setLayoutManager(llm);
        curItem = 1;
        getImageFromApi(detectionDoc.getId(), curItem);
        getParkingListFromApi();
    }

    @Override
    protected void onDestroy() {
        super.onDestroy();
        ImageListAdapter.getInstance().clear();
    }

    @Override
    public void onClick(View view) {
        switch (view.getId()){
            case R.id.btnEvacuationAddImage:
                Intent intent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);
                if (intent.resolveActivity(getPackageManager()) != null) {
                    File photoFile = null;
                    try {
                        photoFile = FileManager.createImageFile(this);
                    } catch (IOException ex) {

                    }
                    if (photoFile != null) {
                        ImageListAdapter.getInstance().addFilePath(photoFile.getAbsolutePath());
                        Uri photoURI = Uri.fromFile(photoFile);
                        intent.putExtra(MediaStore.EXTRA_OUTPUT, photoURI);
                        startActivityForResult(intent, REQUEST_CODE_PHOTO);
                    }
                }
                break;
            case R.id.btnCreateEvacuation:
                createEvacuation();
                break;
        }
    }

    @Override
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        if (requestCode == REQUEST_CODE_PHOTO) {
            if (resultCode == Activity.RESULT_OK) {
                GPSTracker gps = new GPSTracker(this);
                Converter.compressImage(ImageListAdapter.getInstance().getCurrentPath(), Bitmap.CompressFormat.JPEG, 30);
                if (gps.setGpsToFile(ImageListAdapter.getInstance().getCurrentPath())) {
                    BitmapFactory.Options opt = new BitmapFactory.Options();
                    opt.inSampleSize = 8;
                    Bitmap bitmap = BitmapFactory.decodeFile(ImageListAdapter.getInstance().getCurrentPath(), opt);
                    ImageListAdapter.getInstance().add(bitmap);
                }else{
                    ImageListAdapter.getInstance().deleteCurrentPath();
                }
            }else if (resultCode == Activity.RESULT_CANCELED) {
                ImageListAdapter.getInstance().deleteCurrentPath();
            }
        }
    }

    @Override
    public void AuthorizationOK(Response response) {
        if(response.body().getClass() == GetItemImageResponseEnvelope.class){
            GetItemImageResponseEnvelope responseEnvelope = (GetItemImageResponseEnvelope) response.body();
            if (responseEnvelope != null){
                rvImageFromBase.setAdapter(ImageListAdapter.getInstance());
                ImageListAdapter.getInstance()
                        .add(Converter.getBitmapFromBase64Stirng(this, responseEnvelope.getImage()));
                curItem++;
                getImageFromApi(detectionDoc.getId(), curItem);
            }
        }
        if (response.body().getClass() == GetParkingListResponseEnvelope.class){
            GetParkingListResponseEnvelope responseEnvelope = (GetParkingListResponseEnvelope) response.body();
            if (responseEnvelope != null){
                List<Parking> contractors = responseEnvelope.getBody().getParkingList();
                ArrayList<String> stringArrayParkingList = new ArrayList<>();
                for ( Parking parking : contractors) {
                    stringArrayParkingList.add(parking.getName());
                }
                ArrayAdapter<String> arrayAdapterParkinig  = new ArrayAdapter<>(this, android.R.layout.simple_list_item_1, stringArrayParkingList );
                spnParking.setAdapter(arrayAdapterParkinig);
            }
        }
        if (response.body().getClass() == CreateEvacuationResponseEnvelope.class){
            CreateEvacuationResponseEnvelope responseEnvelope = (CreateEvacuationResponseEnvelope) response.body();
            if (responseEnvelope!=null){
                Toast.makeText(this, responseEnvelope.getData(), Toast.LENGTH_SHORT).show();
                this.finish();
            }
        }
    }

    @Override
    public void AuthorizationBad(Response response) {
        Log.d("ERROR", response.message());
    }

    @Override
    public void AuthorizationFail(Throwable t) {
        Log.d("ERROR", t.getLocalizedMessage());

    }

    private void getImageFromApi(String docId, int index){
        RetrofitService retrofitService = Api.createRetrofitService();
        MyCallback<GetItemImageResponseEnvelope> call = new MyCallback<>();
        call.addResponseListener(this);
        retrofitService.executeGetItemImage(
                Encode.getBasicAuthTemplate(
                        UserManager.getInstanse().getmLogin(),
                        UserManager.getInstanse().getmPassword()
                ),
                new GetItemImageRequestEnvelope(docId, index)
        ).enqueue(call);
    }

    private void getParkingListFromApi(){
        RetrofitService retrofitService = Api.createRetrofitService();
        MyCallback<GetParkingListResponseEnvelope> call = new MyCallback<>();
        call.addResponseListener(this);
        retrofitService.executeGetParkingList(
                Encode.getBasicAuthTemplate(
                        UserManager.getInstanse().getmLogin(),
                        UserManager.getInstanse().getmPassword()
                ),
                new GetParkingListRequestEnvelope()
        ).enqueue(call);
    }

    private void createEvacuation(){
        RetrofitService retrofitService = Api.createRetrofitService();
        MyCallback<CreateEvacuationResponseEnvelope> call = new MyCallback<>();
        call.addResponseListener(this);
        ImageList imageList =  new ImageList();
        int count = ImageListAdapter.getInstance().getFilePathCount();
        if (count>0){
            for (int i = 0; i < count; i++){
                imageList.addImage(new Image().setData(Converter.encodeToBase64(ImageListAdapter.getInstance().getFilePath(i))));
            }
        }else{
            imageList.addImage(new Image().setData(""));
        }
        retrofitService.executeCreateEvacuation(
                Encode.getBasicAuthTemplate(
                        UserManager.getInstanse().getmLogin(),
                        UserManager.getInstanse().getmPassword()
                ),
                new CreateEvacuationRequestEnvelope(
                        detectionDoc.getId(),
                        ((swEvacuationOrder.isChecked())?2:1),
                        UserManager.getInstanse().getmLogin(),
                        spnParking.getSelectedItem().toString(),
                        imageList)
        ).enqueue(call);
    }
}
